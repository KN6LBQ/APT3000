<html>
<head>
<script src="wav.js"></script>
<script src="dsp.js"></script>
<script src="demodulator-am.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
<title>APT-3000</title>
</head>
<body>
	<input type="file" id="fileInput"></br>
	<canvas id="myChart" width="1000" height="400"></canvas>
	<script>
		var wavFile;
		var ctx;
		var myChart;
			
		var lower = 80000;
		var range = 200;
		var numTaps = 9;
		var f32samples;
		var filteredData;
		var signalMean = 0;
		
		window.onload = function() {
			try {
			  FileReader = FileReader;
			}
			catch (e) {
			  console.log('Your browser does not support the File API');
			}
			
			var fileInput = document.getElementById('fileInput');
			var fileDisplayArea = document.getElementById('fileDisplayArea');
			ctx = document.getElementById("myChart").getContext("2d");
			
			fileInput.addEventListener('change', function(e) {
				var file = fileInput.files[0];
				//console.log(file);
				
				wavFile = new wav(file);
				wavFile.onloadend = function () {
					console.log("loaded");
					console.log(wavFile);
					
					//rectification
					for(var c = 0; c<wavFile.dataSamples.length;c++){
						wavFile.dataSamples[c] = Math.abs(wavFile.dataSamples[c]);
					}
					console.log("rectified");
					filterSamples();
				};
			});
		}
		
		function filterSamples(){
			var coeffs = getLowPassFIRCoeffs(11025,1800,numTaps);
			var filter = new FIRFilter(coeffs);
			
			//convert to Float32s
			f32samples = new Float32Array(wavFile.dataSamples.length);
			for(var i = 0; i < wavFile.dataSamples.length; i++){
				f32samples[i] = wavFile.dataSamples[i]/32768;
			}
			
			//initialize filter
			filter.loadSamples(f32samples);
			console.log("loaded samples");
			
			//get filtered stuff
			filteredData = new Float32Array(f32samples.length);
			for(var i = 0; i < f32samples.length; i++){
				filteredData[i] = filter.get(i);
			}
			normalizeData();
			updateChart();
		}
		
		function normalizeData(){
			var maxVal = 0;
			for(var i = 0; i < filteredData.length; i++){
				if(filteredData[i]>maxVal){
					maxVal = filteredData[i];
				}
			}
			for(var i = 0; i < filteredData.length; i++){
				filteredData[i] = filteredData[i]/maxVal;
				signalMean += filteredData[i];
			}
			signalMean = signalMean / filteredData.length;
		}
		
		function convolveWithSync(){
			var sync = [-1,-1,-1,-1,-1,1,1,1,1,1,];
			var maxVal = 0;
			var maxIndex = 0;
			for(var i = 0; i < 22050; i++){
				sum = 0;
				for(var c = 0; c < 50; c++){
					sum += (filteredData[i+c]-signalMean)*sync[c%10];
				}
				if(sum>maxVal){
					maxVal = sum;
					maxIndex = i;
				}
			}
			return maxIndex;
		}
		
		function updateChart(){
			var data = {
				labels:wavFile.dataSamples.subarray(lower,lower+range),
				datasets: [
					{
						label: "1040Hz",
						fillColor: "rgba(180,180,180,0.2)",
						strokeColor: "rgba(120,120,120,1)",
						pointColor: "rgba(120,120,120,1)",
						pointStrokeColor: "#fff",
						pointHighlightFill: "#fff",
						pointHighlightStroke: "rgba(220,220,220,1)",
						data: [0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1]
					},
					{
						label: "Filtered",
						fillColor: "rgba(180,180,180,0.2)",
						strokeColor: "rgba(240,120,120,1)",
						pointColor: "rgba(240,120,120,1)",
						pointStrokeColor: "#fff",
						pointHighlightFill: "#fff",
						pointHighlightStroke: "rgba(220,220,220,1)",
						data: filteredData.subarray(lower,lower+range)
					}
				]
			};
					
			 myChart = new Chart(ctx).Line(data);
		}
		
		function changeRange(dLower,dRange){
			lower += dLower;
			range += dRange;
			updateChart();
		}
		
		function setTaps(taps){
			numTaps = taps;
			filterSamples();
		}
	</script>

</body>
</html>
