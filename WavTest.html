<html>
<head>
<script src="wav.js"></script>
<script src="dsp.js"></script>
<script src="demodulator-am.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
<title>APT-3000</title>
</head>
<body>
	<input type="file" id="fileInput"></br>
	<canvas id="myChart" width="1000" height="400"></canvas>
	<script>
		var wavFile;
		var ctx;
		var myChart;
			
		var lower = 80000;
		var range = 200;
		var f32samples;
		var filteredData;
		
		window.onload = function() {
			try {
			  FileReader = FileReader;
			}
			catch (e) {
			  console.log('Your browser does not support the File API');
			}
			
			var fileInput = document.getElementById('fileInput');
			var fileDisplayArea = document.getElementById('fileDisplayArea');
			ctx = document.getElementById("myChart").getContext("2d");
			
			fileInput.addEventListener('change', function(e) {
				var file = fileInput.files[0];
				//console.log(file);
				
				wavFile = new wav(file);
				wavFile.onloadend = function () {
					console.log("loaded");
					console.log(wavFile);
					
					//rectification
					for(var c = 0; c<wavFile.dataSamples.length;c++){
						wavFile.dataSamples[c] = Math.abs(wavFile.dataSamples[c]);
					}
					console.log("rectified");
					
					var coeffs = getLowPassFIRCoeffs(11025,1300,9);
					var filter = new FIRFilter(coeffs);
					
					//convert to Float32s
					f32samples = new Float32Array(wavFile.dataSamples.length);
					for(var i = 0; i < wavFile.dataSamples.length; i++){
						f32samples[i] = wavFile.dataSamples[i]/32768;
					}
					
					//initialize filter
					filter.loadSamples(f32samples);
					console.log("loaded samples");
					
					//get filtered stuff
					filteredData = new Float32Array(f32samples.length);
					for(var i = 0; i < f32samples.length; i++){
						filteredData[i] = filter.get(i);
					}
					
					updateChart();
				};
				
			});
			
			
		}
		
		function updateChart(){
			var data = {
				labels:wavFile.dataSamples.subarray(lower,lower+range),
				datasets: [
					/*{
						label: "Raw",
						fillColor: "rgba(180,180,180,0.2)",
						strokeColor: "rgba(120,120,120,1)",
						pointColor: "rgba(120,120,120,1)",
						pointStrokeColor: "#fff",
						pointHighlightFill: "#fff",
						pointHighlightStroke: "rgba(220,220,220,1)",
						data: f32samples.subarray(lower,lower+range)
					},*/
					{
						label: "Filtered",
						fillColor: "rgba(180,180,180,0.2)",
						strokeColor: "rgba(240,120,120,1)",
						pointColor: "rgba(240,120,120,1)",
						pointStrokeColor: "#fff",
						pointHighlightFill: "#fff",
						pointHighlightStroke: "rgba(220,220,220,1)",
						data: filteredData.subarray(lower,lower+range)
					}
				]
			};
					
			 myChart = new Chart(ctx).Line(data);
		}
		
		function changeRange(dLower,dRange){
			lower += dLower;
			range += dRange;
			updateChart();
		}
	</script>

</body>
</html>
